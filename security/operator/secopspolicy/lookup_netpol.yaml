# This collection of tasks will lookup an Aporeto
# `networkaccesspolicies` policy by filtering for a
# known tag.
# Variables
#   - k8s_uuid
#   - apo_namespace
# Sets
#   - policy_id
- name: Policy Lookup
  when: k8s_uuid is defined and apo_namespace is defined
  shell: |
    /usr/local/bin/apoctl \
    api list networkaccesspolicies \
    --namespace "{{ apo_namespace }}" \
    --filter "associatedTags contains k8s-uuid={{ k8s_uuid }}" \
    -c ID
  register: output
- name: Extract Policy ID
  when: output.stdout != "" and output.stdout | from_json | list | length > 0
  set_fact:
    policy_id: "{{ (output.stdout | from_json | list | first).ID }}"
- name: Found policy
  when: policy_id is defined
  debug: 
    msg: "Found policy with ID {{ policy_id }}"