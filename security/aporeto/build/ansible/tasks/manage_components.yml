---
- name: Run through Helm deployment
  block: 
    - name: Add the helm repo
      command: "helm repo add {{ helm_repo_name }} {{ helm_repo_address }}"

    - name: Fetch helm charts for aporeto-crds
      command: "helm fetch aporeto/aporeto-crds"
    - name: Use Helm Template to create OpenShift Objects
      shell: "helm template aporeto-crds-*.tgz | oc apply -f - "

    - name: Fetch help charts for aporeto-operator
      command: "helm fetch aporeto/aporeto-operator"
    - name: Use Helm Template to create OpenShift Objects
      shell: "helm template aporeto-operator-*.tgz \
        --name aporeto-operator \
        --namespace {{ aporeto_org }}/{{ aporeto_namespace }} \
        | oc apply -f - -n {{ openshift_project }}"

    - name: Fetch helm charts for enforcers
      command: "helm fetch aporeto/enforcerd"
    - name: Use Helm Template to create OpenShift Objects
      shell: "helm template enforcerd-*.tgz \
      --namespace {{ aporeto_org }}/{{ aporeto_namespace }} \
      | oc apply -f - -n {{ openshift_project }} "
