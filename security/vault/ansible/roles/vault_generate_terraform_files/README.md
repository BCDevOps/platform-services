# Ansible Role: vault_generate_terraform_files

After a request came in for a new OpenShift project, within the project provisioning workflow,
Ansible will template out the required terraform files.

See [TODO section](#todo) at the end.

## Requirements

- Ansible needs the licensePlate as an extra variable, which will be used to template out the terraform files
- Ansible needs the OCP cluster as an extra variable, which will be used to template out the terraform files

## Role Variables

Ansible role variables are listed below, along with default values (see `defaults/main.yml`).

```yaml
# OpenShift cluster name (MUST be overwritten by Ansible extra variable)
vault_generate_terraform_files_ocp_cluster: "" # e.g., silver, klab

# OpenShift licensePlate for new application (MUST be overwritten by Ansible extra variable)
vault_generate_terraform_files_lp: ""

# Vault Kubernetes Auth Backend
vault_generate_terraform_files_auth_backend: "{{ 'auth/k8s-' + vault_generate_terraform_files_ocp_cluster }}"

# Name for nonprod Terraform and Vault resources
vault_generate_terraform_files_lp_nonprod: "{{ vault_generate_terraform_files_lp + '-nonprod' }}"

# Name for prod Terraform and Vault resources
vault_generate_terraform_files_lp_prod: "{{ vault_generate_terraform_files_lp + '-prod' }}"

# TTL (in seconds) for Vault Token generated by the Vault Kubernetes Authentication Method
vault_generate_terraform_files_ttl: "3600"

# Bound Kubernetes Service Account Name(s) for Vault Kubernetes Authentication Backend Role
vault_generate_terraform_files_bound_ksa: "{{ vault_generate_terraform_files_lp + '-vault' }}"
```

## Dependencies

- None
<!-- - pip module `openshift >= 0.9.2` -->

## Example Inventory

```ini
[lab]
localhost ansible_connection=local
```

## Example Playbook

```yaml
---
- name: Generate terraform files for new project in Vault
  hosts: all
  gather_facts: True

  roles:
  - vault_generate_terraform_files
```

Always include a `-v` for more verbose output when running `ansible-playbook`. This ensures diagnostic
output is printed on standard out.

Execute the playbook:

```bash
# Example values
ansible-playbook -i inventory/lab playbooks/vault_generate_terraform_files.yml -v --extra-vars '{"vault_generate_terraform_files_ocp_cluster":"klab","vault_generate_terraform_files_lp":"f4igh"}'
```

## TODO

